{% extends 'base.html.twig' %}

{% block body %}

	<div class="container-payment mt-5">
		<div class="row justify-content-center">
			<div class="col-md-6">
				<div class="card-payment">
					<div class="card-body">
						<form action="{{ path('front_order_payment_done', {'orderRef': orderRef}) }}" method="post" id="userInfoForm">
							<h2 class="card-title">
								Vos informations de livraison
							</h2>

							<div class="mb-3">
								<label for="firstName" class="form-label">Prénom:</label>
								<input type="text" class="form-control" id="firstName" name="firstName" placeholder="Entrez votre prénom" value="{{ app.user.firstName ?? '' }}">
							</div>

							<div class="mb-3">
								<label for="lastName" class="form-label">Nom:</label>
								<input type="text" class="form-control" id="lastName" name="lastName" placeholder="Entrez votre nom" value="{{ app.user.lastName ?? '' }}">
							</div>

							<!-- Autres champs de formulaire pour les informations de l'utilisateur -->
							<div class="mb-3">
								<label for="address" class="form-label">Adresse:</label>
								<input type="text" class="form-control" id="address" name="address" placeholder="Adresse">
							</div>

							<div class="mb-3">
								<label for="addressComplement" class="form-label">Complément d'adresse:</label>
								<input type="text" class="form-control" id="addressComplement" name="addressComplement" placeholder="Complément d'adresse">
							</div>

							<div class="mb-3">
								<label for="postalCode" class="form-label">Code postal:</label>
								<input type="text" class="form-control" id="postalCode" name="postalCode" placeholder="Code postal">
							</div>

							<div class="mb-3">
								<label for="city" class="form-label">Ville:</label>
								<input type="text" class="form-control" id="city" name="city" placeholder="Ville">
							</div>

							<div class="mb-3">
								<label for="phone" class="form-label">Numéro de téléphone:</label>
								<input type="text" class="form-control" id="phone" name="phone" placeholder="Entrez votre numéro de téléphone">
							</div>

							<div class="mb-3 form-check">
								<input type="checkbox" class="form-check-input" id="billingCheckbox">
								<label class="form-check-label" for="billingCheckbox">Adresse de Facturation (si différente de l'adresse principale)</label>
							</div>

							<div id="billingAddressFields" style="display: none;">
								<div class="mb-3">
									<label for="billingAddress" class="form-label">Adresse de facturation:</label>
									<input type="text" class="form-control" id="billingAddress" name="billingAddress" placeholder="Adresse">
								</div>

								<div class="mb-3">
									<label for="billingAddressComplement" class="form-label">Complément d'adresse de facturation:</label>
									<input type="text" class="form-control" id="billingAddressComplement" name="billingAddressComplement" placeholder=" Complément d'adresse">
								</div>

								<div class="mb-3">
									<label for="billingPostalCode" class="form-label">Code postal :</label>
									<input type="text" class="form-control" id="billingPostalCode" name="billingPostalCode" placeholder=" Code postal ">
								</div>

								<div class="mb-3">
									<label for="billingCity" class="form-label">Ville :</label>
									<input type="text" class="form-control" id="billingCity" name="billingCity" placeholder="Ville ">
								</div>
							</div>

							<div class="mb-3 text-center">
								<button type="button" class="btn btn-primary-payment" id="validateUserInfo">Valider les informations</button>
							</div>
						</form>
						<!-- Le formulaire de paiement Stripe -->
						<form action="{{ path('front_order_payment_done', {'orderRef': orderRef}) }}" method="post" id="stripePaymentForm">
							<h2 class="card-title">Paiement</h2>

							<div class="mb-3">
								<label for="amount">Montant à payer:</label>
								<input type="text" id="amount" name="amount" placeholder="" value="{{ totalAmount }}" readonly class="form-control">
							</div>

							<div id="card-element"></div>

							<!-- Utilisez les champs supplémentaires ici si nécessaire -->

							<button type="submit" class="btn btn-primary-payment">Payer</button>
						</form>

						<div id="loader"></div>
						<div id="payment-result" class="hidden"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="https://js.stripe.com/v3/"></script>
	<script>
		var stripe = Stripe('{{ stripePublicKey }}');
var elements = stripe.elements();

// Créez le formulaire de paiement ici
var card = elements.create('card');
card.mount('#card-element');

// Gérez l'événement de soumission du formulaire
var form = document.getElementById('stripePaymentForm');
form.addEventListener('submit', function (event) {
event.preventDefault();

// Obtenez le token de la carte avec Stripe.js
stripe.createToken(card).then(function (result) {
if (result.error) { // Informez l'utilisateur de l'erreur (par exemple, problème avec les informations de carte)
alert(result.error.message);
} else { // Ajoutez le token au formulaire avant de le soumettre au serveur
var tokenInput = document.createElement('input');
tokenInput.setAttribute('type', 'hidden');
tokenInput.setAttribute('name', 'stripeToken');
tokenInput.setAttribute('value', result.token.id);
form.appendChild(tokenInput);

// Soumettez le formulaire au serveur
form.submit();
}
});
});

// Gérez l'événement du bouton de validation des informations utilisateur
document.getElementById("validateUserInfo").addEventListener("click", function () {
if (validateUserInfo()) {
document.getElementById("paymentCard").style.display = "block";
} else {
alert("Veuillez remplir tous les champs utilisateur.");
}
});

function validateUserInfo() {
return true;
}
	</script>
{% endblock %}
